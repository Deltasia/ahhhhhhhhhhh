<!-- <!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>YOLO Realtime Webcam</title>
  <style>
    body { font-family: Arial, sans-serif; display:flex; gap:20px; padding:20px; }
    video, img { width: 640px; height: 480px; background: #222; }
    #controls { display:flex; flex-direction:column; gap:8px; }
  </style>
</head>
<body>
  <div>
    <h3>Local webcam (sending frames)</h3>
    <video id="video" autoplay playsinline></video>
    <div>FPS send: <span id="sendFps">-</span></div>
  </div>

  <div id="controls">
    <h3>Server annotated</h3>
    <img id="annotated" alt="annotated frame" />
    <div>Server FPS: <span id="serverFps">-</span></div>
    <label>Confidence threshold: <input type="range" id="conf" min="0.1" max="0.9" step="0.05" value="0.25"></label>
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"
    integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>
   <script src="/static/main.js"></script> -->
<!-- </body>
</html>  -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Realtime YOLO Webcam</title>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    :root {
      color-scheme: dark light;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 24px;
      background: #0f172a;
      color: #e2e8f0;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: flex-start;
    }

    .panel {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.35);
      padding: 24px;
      flex: 1 1 320px;
      min-width: 300px;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 16px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    h2 {
      margin-top: 0;
      font-size: 1.2rem;
      font-weight: 500;
    }

    #video-stream {
      display: block;
      width: 100%;
      max-width: 640px;
      height: auto;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    dl {
      margin: 0;
      display: grid;
      grid-template-columns: auto 1fr;
      row-gap: 8px;
      column-gap: 16px;
      font-size: 0.95rem;
    }

    dt {
      color: #94a3b8;
    }

    dd {
      margin: 0;
      font-variant-numeric: tabular-nums;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 20px;
    }

    button {
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: #38bdf8;
      color: #0f172a;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button.secondary {
      background: transparent;
      color: #e2e8f0;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(14, 165, 233, 0.25);
    }

    .status {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      font-size: 0.9rem;
      background: rgba(30, 41, 59, 0.6);
    }

    .hint {
      margin-top: 12px;
      color: rgba(226, 232, 240, 0.7);
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .error {
      margin-top: 12px;
      color: #f87171;
      font-size: 0.9rem;
    }

    .camera-selector {
      margin-bottom: 16px;
    }

    .camera-selector label {
      display: block;
      margin-bottom: 8px;
      color: #94a3b8;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .camera-selector select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(30, 41, 59, 0.6);
      color: #e2e8f0;
      font-size: 0.9rem;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
      background-position: right 10px center;
      background-repeat: no-repeat;
      background-size: 16px;
      padding-right: 40px;
    }

    .camera-selector select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
    }

    .camera-selector select:hover {
      border-color: rgba(148, 163, 184, 0.5);
    }

    .camera-selector select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .camera-status {
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      transition: all 0.15s ease;
    }

    .camera-status.loading {
      background: rgba(251, 191, 36, 0.1);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.2);
    }

    .camera-status.success {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .camera-status.error {
      background: rgba(248, 113, 113, 0.1);
      color: #f87171;
      border: 1px solid rgba(248, 113, 113, 0.2);
    }

    .camera-status.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <section class="panel">
      <h1>Realtime YOLO Object Detection</h1>
      
      <div class="camera-selector">
        <label for="camera-select">Camera Source:</label>
        <div style="display: flex; gap: 8px; align-items: flex-end;">
          <select id="camera-select" style="flex: 1;">
            <option value="">Loading cameras...</option>
          </select>
          <button id="refresh-cameras" type="button" style="padding: 8px 12px; font-size: 0.8rem; min-width: auto;">
            üîÑ
          </button>
        </div>
        <div id="camera-status" class="camera-status hidden"></div>
      </div>
      
      <img id="video-stream" src="{{ url_for('video') }}" alt="Video stream">
      <div id="calibration-status" class="status">Loading camera status‚Ä¶</div>
    </section>

    <section class="panel">
      <h2>Measurement dashboard</h2>
      <div id="dashboard" hx-get="/dashboard" hx-trigger="load, every 1s" hx-target="#dashboard" hx-swap="innerHTML">
        <div id="calibration-status" class="status">Loading camera status‚Ä¶</div>
        <dl>
          <dt>Latest distance</dt>
          <dd id="latest-distance">‚Äì</dd>
          <dt>Latest angle</dt>
          <dd id="latest-angle">‚Äì</dd>
          <dt>Vertical angle</dt>
          <dd id="latest-vertical-angle">‚Äì</dd>
          <dt>Reference distance</dt>
          <dd id="reference-distance">‚Äì</dd>
          <dt>Reference angle</dt>
          <dd id="reference-angle">‚Äì</dd>
          <dt>Œî distance</dt>
          <dd id="delta-distance">‚Äì</dd>
          <dt>Œî angle</dt>
          <dd id="delta-angle">‚Äì</dd>
          <dt>Lateral shift</dt>
          <dd id="delta-x">‚Äì</dd>
          <dt>Forward shift</dt>
          <dd id="delta-z">‚Äì</dd>
        </dl>
      </div>

      <div class="btn-row">
        <button id="btn-set-reference" type="button" hx-post="/api/reference" hx-target="#error" hx-swap="innerHTML">Set reference</button>
        <button id="btn-clear-reference" type="button" class="secondary" hx-delete="/api/reference" hx-target="#error" hx-swap="innerHTML">Clear reference</button>
      </div>

      <div id="error" class="error" role="alert" aria-live="polite"></div>

      <p class="hint">
        Point the camera at your target, wait for a detection, then press ‚ÄúSet reference‚Äù.
        The dashboard will track how far the object moves relative to that reference point.
      </p>
    </section>

    <section class="panel">
      <h2>Detection Logs</h2>
      <div id="logs" style="max-height: 300px; overflow-y: auto; background: rgba(30, 41, 59, 0.6); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 0.8rem;"></div>
    </section>
  </div>

  <script>
    const socket = io();
    socket.on('log', (data) => {
      const logsDiv = document.getElementById('logs');
      logsDiv.innerHTML += '<pre style="margin: 0; padding: 4px 0;">' + data.replace(/\n/g, '<br>') + '</pre>';
      logsDiv.scrollTop = logsDiv.scrollHeight;
    });

    // Camera selection functionality
    async function loadCameras() {
      try {
        const response = await fetch('/api/cameras');
        const data = await response.json();
        const select = document.getElementById('camera-select');
        
        select.innerHTML = '';
        
        if (data.cameras && data.cameras.length > 0) {
          data.cameras.forEach(camera => {
            const option = document.createElement('option');
            option.value = camera.index;
            option.textContent = camera.name;
            if (camera.index === data.current) {
              option.selected = true;
            }
            select.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No cameras found';
          option.disabled = true;
          select.appendChild(option);
        }
      } catch (error) {
        console.error('Failed to load cameras:', error);
        const select = document.getElementById('camera-select');
        select.innerHTML = '<option value="" disabled>Error loading cameras</option>';
      }
    }

    function showCameraStatus(message, type) {
      const statusEl = document.getElementById('camera-status');
      statusEl.textContent = message;
      statusEl.className = `camera-status ${type}`;
    }

    function hideCameraStatus() {
      const statusEl = document.getElementById('camera-status');
      statusEl.className = 'camera-status hidden';
    }

    async function refreshCameras() {
      const refreshBtn = document.getElementById('refresh-cameras');
      const select = document.getElementById('camera-select');
      
      try {
        refreshBtn.disabled = true;
        refreshBtn.textContent = '‚è≥';
        showCameraStatus('Refreshing camera list...', 'loading');
        
        const response = await fetch('/api/cameras/refresh', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          select.innerHTML = '';
          
          if (data.cameras && data.cameras.length > 0) {
            data.cameras.forEach(camera => {
              const option = document.createElement('option');
              option.value = camera.index;
              option.textContent = camera.name;
              if (camera.index === data.current) {
                option.selected = true;
              }
              select.appendChild(option);
            });
            showCameraStatus('Camera list refreshed', 'success');
          } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No cameras found';
            option.disabled = true;
            select.appendChild(option);
            showCameraStatus('No cameras found', 'error');
          }
          
          setTimeout(hideCameraStatus, 3000);
        } else {
          showCameraStatus('Failed to refresh camera list', 'error');
        }
      } catch (error) {
        console.error('Error refreshing cameras:', error);
        showCameraStatus('Error refreshing cameras', 'error');
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'üîÑ';
      }
    }

    async function switchCamera(index) {
      const select = document.getElementById('camera-select');
      
      try {
        // Show loading state
        select.disabled = true;
        showCameraStatus('Switching camera...', 'loading');
        
        const response = await fetch('/api/camera/switch', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ index: parseInt(index) })
        });
        
        if (response.ok) {
          // Reload the video stream by updating the src attribute
          const videoStream = document.getElementById('video-stream');
          const timestamp = new Date().getTime();
          videoStream.src = `/video?t=${timestamp}`;
          
          const data = await response.json();
          console.log('Camera switched:', data.message);
          showCameraStatus('Camera switched successfully', 'success');
          
          // Hide success message after 3 seconds
          setTimeout(hideCameraStatus, 3000);
        } else {
          const error = await response.json();
          console.error('Failed to switch camera:', error.error);
          showCameraStatus(`Failed to switch camera: ${error.error}`, 'error');
          
          // Reset select to previous value
          await loadCameras();
        }
      } catch (error) {
        console.error('Error switching camera:', error);
        showCameraStatus(`Error switching camera: ${error.message}`, 'error');
        
        // Reset select to previous value
        await loadCameras();
      } finally {
        select.disabled = false;
      }
    }

    // Event listeners
    document.getElementById('camera-select').addEventListener('change', function(e) {
      if (e.target.value) {
        switchCamera(e.target.value);
      }
    });

    document.getElementById('refresh-cameras').addEventListener('click', refreshCameras);

    // Load cameras on page load
    document.addEventListener('DOMContentLoaded', loadCameras);
  </script>
</body>
</html>
